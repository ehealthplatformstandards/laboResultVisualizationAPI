package be.fgov.ehealth.fhir.visualization.rest.fhir.r4;

import be.fgov.ehealth.fhir.visualization.dto.HtmlWithValidation
import be.fgov.ehealth.fhir.visualization.dto.Validation
import be.fgov.ehealth.fhir.visualization.service.ValidatorService
import io.swagger.v3.oas.annotations.Operation
import io.swagger.v3.oas.annotations.tags.Tag
import kotlinx.coroutines.reactor.mono
import kotlinx.coroutines.runBlocking
import org.springframework.http.server.reactive.ServerHttpResponse
import org.springframework.web.bind.annotation.*
import reactor.core.publisher.Mono
import java.util.*

@RestController
@RequestMapping("/rest/fhir/r4/viz/lab")
@Tag(name = "fhir")
class LabController(private val validatorService: ValidatorService) : ControllerInterface {

    override fun fhirValidatorAsync() = validatorService.getValidatorAsync(listOf(
            "hl7.fhir.be.lab#1.0.0"
    ))

    init {
        val fhirData = Base64.getDecoder().decode(
        "eyAgInJlc291cmNlVHlwZSI6ICJCdW5kbGUiLCAgImlkZW50aWZpZXIiOiB7ICAgICJzeXN0ZW0iOiAiaHR0cHM6Ly93d3cuZWhlYWx0aC5mZ292LmJlL2xhYi1yZXBvcnQvYnVuZGxlLWlkIiwgICAgInZhbHVlIjogIjcxMDA4NzUwMDAwLjhhZmY0MjE4LTRkNDAtNGVkNC04NWNlLTE1YWViMzNjZjdhNSIgIH0sICAidHlwZSI6ICJkb2N1bWVudCIsICAidGltZXN0YW1wIjogIjIwMjUtMDEtMDlUMTI6NDY6MzcuNTg4KzAxOjAwIiwgICJlbnRyeSI6IFsgeyAgICAiZnVsbFVybCI6ICJ1cm46dXVpZDoyYjk5NDAxZS0xZGM3LTVlOTctYmM4Ni0wMTMyYzlkMGQ1YmYiLCAgICAicmVzb3VyY2UiOiB7ICAgICAgInJlc291cmNlVHlwZSI6ICJDb21wb3NpdGlvbiIsICAgICAgImlkIjogIjQzOTkiLCAgICAgICJtZXRhIjogeyAgICAgICAgInByb2ZpbGUiOiBbICJodHRwczovL3d3dy5laGVhbHRoLmZnb3YuYmUvc3RhbmRhcmRzL2ZoaXIvbGFiL1N0cnVjdHVyZURlZmluaXRpb24vYmUtbGFib3JhdG9yeS1yZXBvcnQtY29tcG9zaXRpb24iIF0gICAgICB9LCAgICAgICJ0ZXh0IjogeyAgICAgICAgInN0YXR1cyI6ICJlbXB0eSIsICAgICAgICAiZGl2IjogIjxkaXYgeG1sbnM9XCJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sXCI+ZW1wdHk8L2Rpdj4iICAgICAgfSwgICAgICAiaWRlbnRpZmllciI6IHsgICAgICAgICJzeXN0ZW0iOiAiaHR0cHM6Ly93d3cuZWhlYWx0aC5mZ292LmJlL2xhYi1yZXBvcnQvZGlhZ25vc3RpYy1yZXBvcnQtaWQiLCAgICAgICAgInZhbHVlIjogIjcxMDA4NzUwMDAwLjYzMDAwNDQ3IiAgICAgIH0sICAgICAgInN0YXR1cyI6ICJmaW5hbCIsICAgICAgInR5cGUiOiB7ICAgICAgICAiY29kaW5nIjogWyB7ICAgICAgICAgICJzeXN0ZW0iOiAiaHR0cDovL2xvaW5jLm9yZyIsICAgICAgICAgICJjb2RlIjogIjExNTAyLTIiLCAgICAgICAgICAiZGlzcGxheSI6ICJMYWJvcmF0b3J5IHJlcG9ydCIgICAgICAgIH0gXSAgICAgIH0sICAgICAgInN1YmplY3QiOiB7ICAgICAgICAicmVmZXJlbmNlIjogInVybjp1dWlkOjg0MjBlMmExLWYyNDEtNTNjYy1hOGNiLTc5MTNlMjkzMTM3MCIgICAgICB9LCAgICAgICJkYXRlIjogIjIwMjUtMDEtMDlUMTI6NDY6MzcrMDE6MDAiLCAgICAgICJhdXRob3IiOiBbIHsgICAgICAgICJyZWZlcmVuY2UiOiAidXJuOnV1aWQ6MWU4OWNiODQtMDk3YS01NzgyLTk1OWUtNjkxNTFiMDAxODJjIiAgICAgIH0gXSwgICAgICAidGl0bGUiOiAiTGFib3JhdG9yeSBSZXBvcnQiLCAgICAgICJzZWN0aW9uIjogWyB7ICAgICAgICAiZW50cnkiOiBbIHsgICAgICAgICAgInJlZmVyZW5jZSI6ICJ1cm46dXVpZDozMzI5YWY5ZS0zMDk5LTU3NDMtYWVhMC0xNWM1Yzc5NmYyZmYiICAgICAgICB9IF0gICAgICB9IF0gICAgfSAgfSwgeyAgICAiZnVsbFVybCI6ICJ1cm46dXVpZDozMzI5YWY5ZS0zMDk5LTU3NDMtYWVhMC0xNWM1Yzc5NmYyZmYiLCAgICAicmVzb3VyY2UiOiB7ICAgICAgInJlc291cmNlVHlwZSI6ICJEaWFnbm9zdGljUmVwb3J0IiwgICAgICAiaWQiOiAiNDM5OSIsICAgICAgIm1ldGEiOiB7ICAgICAgICAidmVyc2lvbklkIjogIjMiLCAgICAgICAgInByb2ZpbGUiOiBbICJodHRwczovL3d3dy5laGVhbHRoLmZnb3YuYmUvc3RhbmRhcmRzL2ZoaXIvbGFiL1N0cnVjdHVyZURlZmluaXRpb24vYmUtbGFib3JhdG9yeS1yZXBvcnQiIF0gICAgICB9LCAgICAgICJ0ZXh0IjogeyAgICAgICAgInN0YXR1cyI6ICJlbXB0eSIsICAgICAgICAiZGl2IjogIjxkaXYgeG1sbnM9XCJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sXCI+ZW1wdHk8L2Rpdj4iICAgICAgfSwgICAgICAiaWRlbnRpZmllciI6IFsgeyAgICAgICAgInN5c3RlbSI6ICJodHRwczovL3d3dy5laGVhbHRoLmZnb3YuYmUvbGFiLXJlcG9ydC9kaWFnbm9zdGljLXJlcG9ydC1pZCIsICAgICAgICAidmFsdWUiOiAiNzEwMDg3NTAwMDAuNjMwMDA0NDciICAgICAgfSBdLCAgICAgICJiYXNlZE9uIjogWyB7ICAgICAgICAicmVmZXJlbmNlIjogInVybjp1dWlkOmE1OTBmNmFlLTE2OGQtNTE0OC04ZGRiLWY2OTU4MDcwYTE5NSIgICAgICB9IF0sICAgICAgInN0YXR1cyI6ICJmaW5hbCIsICAgICAgImNhdGVnb3J5IjogWyB7ICAgICAgICAiY29kaW5nIjogWyB7ICAgICAgICAgICJzeXN0ZW0iOiAiaHR0cDovL3Rlcm1pbm9sb2d5LmhsNy5vcmcvQ29kZVN5c3RlbS92Mi0wMDc0IiwgICAgICAgICAgImNvZGUiOiAiTEFCIiwgICAgICAgICAgImRpc3BsYXkiOiAiTGFib3JhdG9yeSIgICAgICAgIH0gXSAgICAgIH0gXSwgICAgICAiY29kZSI6IHsgICAgICAgICJjb2RpbmciOiBbIHsgICAgICAgICAgInN5c3RlbSI6ICJodHRwOi8vbG9pbmMub3JnIiwgICAgICAgICAgImNvZGUiOiAiMTE1MDItMiIgICAgICAgIH0gXSwgICAgICAgICJ0ZXh0IjogIkxhYm8gcmFwcG9ydCIgICAgICB9LCAgICAgICJzdWJqZWN0IjogeyAgICAgICAgInJlZmVyZW5jZSI6ICJ1cm46dXVpZDo4NDIwZTJhMS1mMjQxLTUzY2MtYThjYi03OTEzZTI5MzEzNzAiICAgICAgfSwgICAgICAiZWZmZWN0aXZlRGF0ZVRpbWUiOiAiMjAyNS0wMS0wOVQxMjo0NjozNyswMTowMCIsICAgICAgImlzc3VlZCI6ICIyMDI0LTEwLTIyVDEzOjA3OjU0LjAwMCswMjowMCIsICAgICAgInBlcmZvcm1lciI6IFsgeyAgICAgICAgInJlZmVyZW5jZSI6ICJ1cm46dXVpZDoxZTg5Y2I4NC0wOTdhLTU3ODItOTU5ZS02OTE1MWIwMDE4MmMiICAgICAgfSBdLCAgICAgICJyZXN1bHRzSW50ZXJwcmV0ZXIiOiBbIHsgICAgICAgICJyZWZlcmVuY2UiOiAidXJuOnV1aWQ6MTg2NzRhOWEtZTcxYi01ZWYyLTk3YzQtMmRlN2QzODg5Yzg0IiAgICAgIH0gXSwgICAgICAic3BlY2ltZW4iOiBbIHsgICAgICAgICJyZWZlcmVuY2UiOiAidXJuOnV1aWQ6YWRhYmI5MDctODg1Ni01MjI1LWE2OWUtNDI5NThmY2E1ZThiIiAgICAgIH0gXSwgICAgICAicmVzdWx0IjogWyB7ICAgICAgICAicmVmZXJlbmNlIjogInVybjp1dWlkOmVhYjczZjI2LWNjYWQtNTBlNS04ODgxLTIyZjYwMTA5ZjM2YSIgICAgICB9LCB7ICAgICAgICAicmVmZXJlbmNlIjogInVybjp1dWlkOjM1Yjk1YTE2LTk1YTEtNTU5ZC05NGZlLWYxMDM0ZDIzMmYxMSIgICAgICB9IF0gICAgfSAgfSwgeyAgICAiZnVsbFVybCI6ICJ1cm46dXVpZDo4NDIwZTJhMS1mMjQxLTUzY2MtYThjYi03OTEzZTI5MzEzNzAiLCAgICAicmVzb3VyY2UiOiB7ICAgICAgInJlc291cmNlVHlwZSI6ICJQYXRpZW50IiwgICAgICAiaWQiOiAiMTQwNTUzNiIsICAgICAgIm1ldGEiOiB7ICAgICAgICAicHJvZmlsZSI6IFsgImh0dHBzOi8vd3d3LmVoZWFsdGguZmdvdi5iZS9zdGFuZGFyZHMvZmhpci9jb3JlL1N0cnVjdHVyZURlZmluaXRpb24vYmUtcGF0aWVudCIgXSAgICAgIH0sICAgICAgInRleHQiOiB7ICAgICAgICAic3RhdHVzIjogImVtcHR5IiwgICAgICAgICJkaXYiOiAiPGRpdiB4bWxucz1cImh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWxcIj5lbXB0eTwvZGl2PiIgICAgICB9LCAgICAgICJpZGVudGlmaWVyIjogWyB7ICAgICAgICAidXNlIjogIm9mZmljaWFsIiwgICAgICAgICJzeXN0ZW0iOiAiaHR0cHM6Ly93d3cuZWhlYWx0aC5mZ292LmJlL3N0YW5kYXJkcy9maGlyL2NvcmUvTmFtaW5nU3lzdGVtL3NzaW4iLCAgICAgICAgInZhbHVlIjogIjAwMDEyNTk5OTA0IiAgICAgIH0sIHsgICAgICAgICJzeXN0ZW0iOiAiaHR0cDovL21pcHMuYmUvSElTIiwgICAgICAgICJ2YWx1ZSI6ICIxOTAwMDEyNVBBVFAwNiIgICAgICB9IF0sICAgICAgIm5hbWUiOiBbIHsgICAgICAgICJmYW1pbHkiOiAiUGF0aWVudE5hbWUyNSIsICAgICAgICAiZ2l2ZW4iOiBbICJQYXRpZW50MjUiIF0gICAgICB9IF0sICAgICAgImdlbmRlciI6ICJtYWxlIiwgICAgICAiYmlydGhEYXRlIjogIjE5MDAtMDEtMjUiICAgIH0gIH0sIHsgICAgImZ1bGxVcmwiOiAidXJuOnV1aWQ6YTU5MGY2YWUtMTY4ZC01MTQ4LThkZGItZjY5NTgwNzBhMTk1IiwgICAgInJlc291cmNlIjogeyAgICAgICJyZXNvdXJjZVR5cGUiOiAiU2VydmljZVJlcXVlc3QiLCAgICAgICJpZCI6ICI2MzAwMDQ0NyIsICAgICAgInRleHQiOiB7ICAgICAgICAic3RhdHVzIjogImVtcHR5IiwgICAgICAgICJkaXYiOiAiPGRpdiB4bWxucz1cImh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWxcIj5lbXB0eTwvZGl2PiIgICAgICB9LCAgICAgICJpZGVudGlmaWVyIjogWyB7ICAgICAgICAic3lzdGVtIjogImh0dHBzOi8vd3d3Lmhpcy1penouYmUiLCAgICAgICAgInZhbHVlIjogIjYzMDAwNDQ3IiAgICAgIH0gXSwgICAgICAic3RhdHVzIjogImNvbXBsZXRlZCIsICAgICAgImludGVudCI6ICJvcmRlciIsICAgICAgInByaW9yaXR5IjogInJvdXRpbmUiLCAgICAgICJzdWJqZWN0IjogeyAgICAgICAgInJlZmVyZW5jZSI6ICJ1cm46dXVpZDo4NDIwZTJhMS1mMjQxLTUzY2MtYThjYi03OTEzZTI5MzEzNzAiICAgICAgfSwgICAgICAiYXV0aG9yZWRPbiI6ICIyMDI0LTEwLTIyVDEzOjA2OjAwKzAyOjAwIiwgICAgICAicmVxdWVzdGVyIjogeyAgICAgICAgInJlZmVyZW5jZSI6ICJ1cm46dXVpZDoxODY3NGE5YS1lNzFiLTVlZjItOTdjNC0yZGU3ZDM4ODljODQiICAgICAgfSAgICB9ICB9LCB7ICAgICJmdWxsVXJsIjogInVybjp1dWlkOjE4Njc0YTlhLWU3MWItNWVmMi05N2M0LTJkZTdkMzg4OWM4NCIsICAgICJyZXNvdXJjZSI6IHsgICAgICAicmVzb3VyY2VUeXBlIjogIlByYWN0aXRpb25lciIsICAgICAgImlkIjogIjE2MzI5MzMiLCAgICAgICJtZXRhIjogeyAgICAgICAgInByb2ZpbGUiOiBbICJodHRwczovL3d3dy5laGVhbHRoLmZnb3YuYmUvc3RhbmRhcmRzL2ZoaXIvY29yZS9TdHJ1Y3R1cmVEZWZpbml0aW9uL2JlLXByYWN0aXRpb25lciIgXSAgICAgIH0sICAgICAgInRleHQiOiB7ICAgICAgICAic3RhdHVzIjogImVtcHR5IiwgICAgICAgICJkaXYiOiAiPGRpdiB4bWxucz1cImh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWxcIj5lbXB0eTwvZGl2PiIgICAgICB9LCAgICAgICJpZGVudGlmaWVyIjogWyB7ICAgICAgICAidXNlIjogIm9mZmljaWFsIiwgICAgICAgICJzeXN0ZW0iOiAiaHR0cHM6Ly93d3cuZWhlYWx0aC5mZ292LmJlL3N0YW5kYXJkcy9maGlyL2NvcmUvTmFtaW5nU3lzdGVtL25paGRpIiwgICAgICAgICJ2YWx1ZSI6ICIxODkxNTI5NTg2MCIgICAgICB9IF0sICAgICAgIm5hbWUiOiBbIHsgICAgICAgICJmYW1pbHkiOiAiQmV1a2luZ2EiLCAgICAgICAgImdpdmVuIjogWyAiSW5ncmlkIiBdLCAgICAgICAgInByZWZpeCI6IFsgIkRyLiIgXSAgICAgIH0gXSwgICAgICAidGVsZWNvbSI6IFsgeyAgICAgICAgInN5c3RlbSI6ICJlbWFpbCIsICAgICAgICAidmFsdWUiOiAia2NoYXBlbGxlQGhpcy1penouYmUiICAgICAgfSBdLCAgICAgICJhZGRyZXNzIjogWyB7ICAgICAgICAibGluZSI6IFsgIlJVRSBKRUFOIFBBUVVPVCwgNjMiIF0sICAgICAgICAiY2l0eSI6ICJJWEVMTEVTIiwgICAgICAgICJwb3N0YWxDb2RlIjogIjEwNTAiLCAgICAgICAgImNvdW50cnkiOiAiQiIgICAgICB9IF0gICAgfSAgfSwgeyAgICAiZnVsbFVybCI6ICJ1cm46dXVpZDoxZTg5Y2I4NC0wOTdhLTU3ODItOTU5ZS02OTE1MWIwMDE4MmMiLCAgICAicmVzb3VyY2UiOiB7ICAgICAgInJlc291cmNlVHlwZSI6ICJPcmdhbml6YXRpb24iLCAgICAgICJpZCI6ICIxMzk5NDgiLCAgICAgICJtZXRhIjogeyAgICAgICAgInByb2ZpbGUiOiBbICJodHRwczovL3d3dy5laGVhbHRoLmZnb3YuYmUvc3RhbmRhcmRzL2ZoaXIvY29yZS9TdHJ1Y3R1cmVEZWZpbml0aW9uL2JlLW9yZ2FuaXphdGlvbiIgXSAgICAgIH0sICAgICAgInRleHQiOiB7ICAgICAgICAic3RhdHVzIjogImVtcHR5IiwgICAgICAgICJkaXYiOiAiPGRpdiB4bWxucz1cImh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWxcIj5lbXB0eTwvZGl2PiIgICAgICB9LCAgICAgICJpZGVudGlmaWVyIjogWyB7ICAgICAgICAidXNlIjogIm9mZmljaWFsIiwgICAgICAgICJzeXN0ZW0iOiAiaHR0cHM6Ly93d3cuZWhlYWx0aC5mZ292LmJlL3N0YW5kYXJkcy9maGlyL2NvcmUvTmFtaW5nU3lzdGVtL25paGRpIiwgICAgICAgICJ2YWx1ZSI6ICI4Mjg2NjcwNDk5OCIgICAgICB9IF0sICAgICAgIm5hbWUiOiAiTF9ISVMiLCAgICAgICJhZGRyZXNzIjogWyB7ICAgICAgICAibGluZSI6IFsgIlJ1ZSBKZWFuIFBhcXVvdCwgNjMiIF0sICAgICAgICAiY2l0eSI6ICJJWEVMTEVTIiwgICAgICAgICJwb3N0YWxDb2RlIjogIjEwNTAiLCAgICAgICAgImNvdW50cnkiOiAiQiIgICAgICB9IF0gICAgfSAgfSwgeyAgICAiZnVsbFVybCI6ICJ1cm46dXVpZDplYWI3M2YyNi1jY2FkLTUwZTUtODg4MS0yMmY2MDEwOWYzNmEiLCAgICAicmVzb3VyY2UiOiB7ICAgICAgInJlc291cmNlVHlwZSI6ICJPYnNlcnZhdGlvbiIsICAgICAgImlkIjogIjA1Y2VjNmZkLTkxNDctNGUyMy1hMjAzLTQyMTI3ZGU4YmQxZiIsICAgICAgIm1ldGEiOiB7ICAgICAgICAicHJvZmlsZSI6IFsgImh0dHBzOi8vd3d3LmVoZWFsdGguZmdvdi5iZS9zdGFuZGFyZHMvZmhpci9sYWIvU3RydWN0dXJlRGVmaW5pdGlvbi9iZS1vYnNlcnZhdGlvbi1sYWJvcmF0b3J5IiBdICAgICAgfSwgICAgICAidGV4dCI6IHsgICAgICAgICJzdGF0dXMiOiAiZW1wdHkiLCAgICAgICAgImRpdiI6ICI8ZGl2IHhtbG5zPVwiaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbFwiPmVtcHR5PC9kaXY+IiAgICAgIH0sICAgICAgInN0YXR1cyI6ICJ1bmtub3duIiwgICAgICAiY29kZSI6IHsgICAgICAgICJ0ZXh0IjogIlJlbnNlaWduZW1lbnRzIGNsaW5pcXVlcyIgICAgICB9LCAgICAgICJzdWJqZWN0IjogeyAgICAgICAgInJlZmVyZW5jZSI6ICJ1cm46dXVpZDo4NDIwZTJhMS1mMjQxLTUzY2MtYThjYi03OTEzZTI5MzEzNzAiICAgICAgfSwgICAgICAiaGFzTWVtYmVyIjogWyB7ICAgICAgICAicmVmZXJlbmNlIjogInVybjp1dWlkOmNmYzVmMmVlLWQyMTktNTU3ZC04OTJjLWZmZTFiMzI2OGMwOCIgICAgICB9IF0gICAgfSAgfSwgeyAgICAiZnVsbFVybCI6ICJ1cm46dXVpZDowMWY2ZjM0OC1hOTlmLTU1ZGItOTdlMS01ZjY0OTcxZTMzZmEiLCAgICAicmVzb3VyY2UiOiB7ICAgICAgInJlc291cmNlVHlwZSI6ICJPYnNlcnZhdGlvbiIsICAgICAgImlkIjogImQ0ZTdhYzk1LWFiN2QtNDQ4MC1hYjA3LTA2NzEwNTk3ZTQzNCIsICAgICAgIm1ldGEiOiB7ICAgICAgICAicHJvZmlsZSI6IFsgImh0dHBzOi8vd3d3LmVoZWFsdGguZmdvdi5iZS9zdGFuZGFyZHMvZmhpci9sYWIvU3RydWN0dXJlRGVmaW5pdGlvbi9iZS1vYnNlcnZhdGlvbi1sYWJvcmF0b3J5IiBdICAgICAgfSwgICAgICAidGV4dCI6IHsgICAgICAgICJzdGF0dXMiOiAiZW1wdHkiLCAgICAgICAgImRpdiI6ICI8ZGl2IHhtbG5zPVwiaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbFwiPmVtcHR5PC9kaXY+IiAgICAgIH0sICAgICAgInN0YXR1cyI6ICJ1bmtub3duIiwgICAgICAiY29kZSI6IHsgICAgICAgICJ0ZXh0IjogIk3DqXRhYm9saXNtZSBnbHVjaWRpcXVlIiAgICAgIH0sICAgICAgInN1YmplY3QiOiB7ICAgICAgICAicmVmZXJlbmNlIjogInVybjp1dWlkOjg0MjBlMmExLWYyNDEtNTNjYy1hOGNiLTc5MTNlMjkzMTM3MCIgICAgICB9LCAgICAgICJoYXNNZW1iZXIiOiBbIHsgICAgICAgICJyZWZlcmVuY2UiOiAidXJuOnV1aWQ6ZGM2MjRhN2QtNTc4Yi01ZmE4LTgyOWEtM2Y4OGZhNWM3N2U0IiAgICAgIH0gXSAgICB9ICB9LCB7ICAgICJmdWxsVXJsIjogInVybjp1dWlkOjM1Yjk1YTE2LTk1YTEtNTU5ZC05NGZlLWYxMDM0ZDIzMmYxMSIsICAgICJyZXNvdXJjZSI6IHsgICAgICAicmVzb3VyY2VUeXBlIjogIk9ic2VydmF0aW9uIiwgICAgICAiaWQiOiAiNjExMTA4MmYtMTcxYi00OTQ2LThhZDAtNjExNGU0NGFhNDc4IiwgICAgICAibWV0YSI6IHsgICAgICAgICJwcm9maWxlIjogWyAiaHR0cHM6Ly93d3cuZWhlYWx0aC5mZ292LmJlL3N0YW5kYXJkcy9maGlyL2xhYi9TdHJ1Y3R1cmVEZWZpbml0aW9uL2JlLW9ic2VydmF0aW9uLWxhYm9yYXRvcnkiIF0gICAgICB9LCAgICAgICJ0ZXh0IjogeyAgICAgICAgInN0YXR1cyI6ICJlbXB0eSIsICAgICAgICAiZGl2IjogIjxkaXYgeG1sbnM9XCJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sXCI+ZW1wdHk8L2Rpdj4iICAgICAgfSwgICAgICAic3RhdHVzIjogInVua25vd24iLCAgICAgICJjb2RlIjogeyAgICAgICAgInRleHQiOiAiQmlvY2hpbWllIiAgICAgIH0sICAgICAgInN1YmplY3QiOiB7ICAgICAgICAicmVmZXJlbmNlIjogInVybjp1dWlkOjg0MjBlMmExLWYyNDEtNTNjYy1hOGNiLTc5MTNlMjkzMTM3MCIgICAgICB9LCAgICAgICJoYXNNZW1iZXIiOiBbIHsgICAgICAgICJyZWZlcmVuY2UiOiAidXJuOnV1aWQ6MDFmNmYzNDgtYTk5Zi01NWRiLTk3ZTEtNWY2NDk3MWUzM2ZhIiAgICAgIH0gXSAgICB9ICB9LCB7ICAgICJmdWxsVXJsIjogInVybjp1dWlkOmU1MjdkOGFkLWZkZGYtNTQ0NC1iOGYyLThhYzgxYzQ0Y2FhNiIsICAgICJyZXNvdXJjZSI6IHsgICAgICAicmVzb3VyY2VUeXBlIjogIlNlcnZpY2VSZXF1ZXN0IiwgICAgICAiaWQiOiAiMjQwOTIiLCAgICAgICJ0ZXh0IjogeyAgICAgICAgInN0YXR1cyI6ICJlbXB0eSIsICAgICAgICAiZGl2IjogIjxkaXYgeG1sbnM9XCJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sXCI+ZW1wdHk8L2Rpdj4iICAgICAgfSwgICAgICAiaWRlbnRpZmllciI6IFsgeyAgICAgICAgInN5c3RlbSI6ICJodHRwczovL3d3dy5oaXMtaXp6LmJlIiwgICAgICAgICJ2YWx1ZSI6ICIyNDA5MiIgICAgICB9IF0sICAgICAgInN0YXR1cyI6ICJjb21wbGV0ZWQiLCAgICAgICJpbnRlbnQiOiAib3JkZXIiLCAgICAgICJwcmlvcml0eSI6ICJyb3V0aW5lIiwgICAgICAic3ViamVjdCI6IHsgICAgICAgICJyZWZlcmVuY2UiOiAidXJuOnV1aWQ6ODQyMGUyYTEtZjI0MS01M2NjLWE4Y2ItNzkxM2UyOTMxMzcwIiAgICAgIH0gICAgfSAgfSwgeyAgICAiZnVsbFVybCI6ICJ1cm46dXVpZDplMjk4NTY5OS03NGI2LTU3Y2UtOTc3NS05NTk3YjdhYzgyYTYiLCAgICAicmVzb3VyY2UiOiB7ICAgICAgInJlc291cmNlVHlwZSI6ICJTZXJ2aWNlUmVxdWVzdCIsICAgICAgImlkIjogIjI0MDk0IiwgICAgICAidGV4dCI6IHsgICAgICAgICJzdGF0dXMiOiAiZW1wdHkiLCAgICAgICAgImRpdiI6ICI8ZGl2IHhtbG5zPVwiaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbFwiPmVtcHR5PC9kaXY+IiAgICAgIH0sICAgICAgImlkZW50aWZpZXIiOiBbIHsgICAgICAgICJzeXN0ZW0iOiAiaHR0cHM6Ly93d3cuaGlzLWl6ei5iZSIsICAgICAgICAidmFsdWUiOiAiMjQwOTQiICAgICAgfSBdLCAgICAgICJzdGF0dXMiOiAiY29tcGxldGVkIiwgICAgICAiaW50ZW50IjogIm9yZGVyIiwgICAgICAicHJpb3JpdHkiOiAicm91dGluZSIsICAgICAgInN1YmplY3QiOiB7ICAgICAgICAicmVmZXJlbmNlIjogInVybjp1dWlkOjg0MjBlMmExLWYyNDEtNTNjYy1hOGNiLTc5MTNlMjkzMTM3MCIgICAgICB9ICAgIH0gIH0sIHsgICAgImZ1bGxVcmwiOiAidXJuOnV1aWQ6Y2ZjNWYyZWUtZDIxOS01NTdkLTg5MmMtZmZlMWIzMjY4YzA4IiwgICAgInJlc291cmNlIjogeyAgICAgICJyZXNvdXJjZVR5cGUiOiAiT2JzZXJ2YXRpb24iLCAgICAgICJpZCI6ICIxNzkzNDgiLCAgICAgICJtZXRhIjogeyAgICAgICAgInByb2ZpbGUiOiBbICJodHRwczovL3d3dy5laGVhbHRoLmZnb3YuYmUvc3RhbmRhcmRzL2ZoaXIvbGFiL1N0cnVjdHVyZURlZmluaXRpb24vYmUtb2JzZXJ2YXRpb24tbGFib3JhdG9yeSIgXSAgICAgIH0sICAgICAgInRleHQiOiB7ICAgICAgICAic3RhdHVzIjogImVtcHR5IiwgICAgICAgICJkaXYiOiAiPGRpdiB4bWxucz1cImh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWxcIj5lbXB0eTwvZGl2PiIgICAgICB9LCAgICAgICJiYXNlZE9uIjogWyB7ICAgICAgICAicmVmZXJlbmNlIjogInVybjp1dWlkOmU1MjdkOGFkLWZkZGYtNTQ0NC1iOGYyLThhYzgxYzQ0Y2FhNiIgICAgICB9IF0sICAgICAgInN0YXR1cyI6ICJmaW5hbCIsICAgICAgImNvZGUiOiB7ICAgICAgICAiY29kaW5nIjogWyB7ICAgICAgICAgICJzeXN0ZW0iOiAiaHR0cDovL2xvaW5jLm9yZyIsICAgICAgICAgICJjb2RlIjogIjU1NzUyLTAiICAgICAgICB9IF0sICAgICAgICAidGV4dCI6ICJhdXRyZXMgOiIgICAgICB9LCAgICAgICJzdWJqZWN0IjogeyAgICAgICAgInJlZmVyZW5jZSI6ICJ1cm46dXVpZDo4NDIwZTJhMS1mMjQxLTUzY2MtYThjYi03OTEzZTI5MzEzNzAiICAgICAgfSwgICAgICAiaXNzdWVkIjogIjIwMjQtMTAtMjJUMTM6MDc6MTYuMDAwKzAyOjAwIiwgICAgICAidmFsdWVTdHJpbmciOiAiRGlhYmV0ZXMgbWVsbGl0dXMiICAgIH0gIH0sIHsgICAgImZ1bGxVcmwiOiAidXJuOnV1aWQ6ZGM2MjRhN2QtNTc4Yi01ZmE4LTgyOWEtM2Y4OGZhNWM3N2U0IiwgICAgInJlc291cmNlIjogeyAgICAgICJyZXNvdXJjZVR5cGUiOiAiT2JzZXJ2YXRpb24iLCAgICAgICJpZCI6ICIxNzkzNDkiLCAgICAgICJtZXRhIjogeyAgICAgICAgInByb2ZpbGUiOiBbICJodHRwczovL3d3dy5laGVhbHRoLmZnb3YuYmUvc3RhbmRhcmRzL2ZoaXIvbGFiL1N0cnVjdHVyZURlZmluaXRpb24vYmUtb2JzZXJ2YXRpb24tbGFib3JhdG9yeSIgXSAgICAgIH0sICAgICAgInRleHQiOiB7ICAgICAgICAic3RhdHVzIjogImVtcHR5IiwgICAgICAgICJkaXYiOiAiPGRpdiB4bWxucz1cImh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWxcIj5lbXB0eTwvZGl2PiIgICAgICB9LCAgICAgICJiYXNlZE9uIjogWyB7ICAgICAgICAicmVmZXJlbmNlIjogInVybjp1dWlkOmUyOTg1Njk5LTc0YjYtNTdjZS05Nzc1LTk1OTdiN2FjODJhNiIgICAgICB9IF0sICAgICAgInN0YXR1cyI6ICJmaW5hbCIsICAgICAgImNvZGUiOiB7ICAgICAgICAiY29kaW5nIjogWyB7ICAgICAgICAgICJzeXN0ZW0iOiAiaHR0cDovL2xvaW5jLm9yZyIsICAgICAgICAgICJjb2RlIjogIjIzNDUtNyIgICAgICAgIH0gXSwgICAgICAgICJ0ZXh0IjogIkdsdWNvc2UiICAgICAgfSwgICAgICAic3ViamVjdCI6IHsgICAgICAgICJyZWZlcmVuY2UiOiAidXJuOnV1aWQ6ODQyMGUyYTEtZjI0MS01M2NjLWE4Y2ItNzkxM2UyOTMxMzcwIiAgICAgIH0sICAgICAgImlzc3VlZCI6ICIyMDI0LTEwLTIyVDEzOjA3OjM2LjAwMCswMjowMCIsICAgICAgInZhbHVlUXVhbnRpdHkiOiB7ICAgICAgICAidmFsdWUiOiAxNzgsICAgICAgICAidW5pdCI6ICJtZy9kTCIsICAgICAgICAic3lzdGVtIjogImh0dHA6Ly91bml0c29mbWVhc3VyZS5vcmciLCAgICAgICAgImNvZGUiOiAibWcvZEwiICAgICAgfSwgICAgICAiaW50ZXJwcmV0YXRpb24iOiBbIHsgICAgICAgICJjb2RpbmciOiBbIHsgICAgICAgICAgInN5c3RlbSI6ICJodHRwOi8vdGVybWlub2xvZ3kuaGw3Lm9yZy9Db2RlU3lzdGVtL3YzLU9ic2VydmF0aW9uSW50ZXJwcmV0YXRpb24iLCAgICAgICAgICAiY29kZSI6ICJIIiAgICAgICAgfSBdICAgICAgfSBdLCAgICAgICJub3RlIjogWyB7ICAgICAgICAiZXh0ZW5zaW9uIjogWyB7ICAgICAgICAgICJ1cmwiOiAiaHR0cHM6Ly93d3cuZWhlYWx0aC5mZ292LmJlL3N0YW5kYXJkcy9maGlyL2xhYi9TdHJ1Y3R1cmVEZWZpbml0aW9uL2Fubm90YXRpb24tY29kZSIsICAgICAgICAgICJ2YWx1ZUNvZGVhYmxlQ29uY2VwdCI6IHsgICAgICAgICAgICAiY29kaW5nIjogWyB7ICAgICAgICAgICAgICAic3lzdGVtIjogImh0dHBzOi8vd3d3LmVoZWFsdGguZmdvdi5iZS9zdGFuZGFyZHMvZmhpci9sYWIvQ29kZVN5c3RlbS9iZS1jcy1jb2RlZC1hbm5vdGF0aW9uLXR5cGVzIiwgICAgICAgICAgICAgICJjb2RlIjogImxhYi10ZXN0LWFjY3JlZGl0YXRpb24iICAgICAgICAgICAgfSBdICAgICAgICAgIH0gICAgICAgIH0gXSwgICAgICAgICJ0ZXh0IjogIkJFTEFDIiAgICAgIH0gXSwgICAgICAic3BlY2ltZW4iOiB7ICAgICAgICAicmVmZXJlbmNlIjogInVybjp1dWlkOmFkYWJiOTA3LTg4NTYtNTIyNS1hNjllLTQyOTU4ZmNhNWU4YiIgICAgICB9LCAgICAgICJyZWZlcmVuY2VSYW5nZSI6IFsgeyAgICAgICAgImxvdyI6IHsgICAgICAgICAgInZhbHVlIjogNzAsICAgICAgICAgICJ1bml0IjogIm1nL2RMIiwgICAgICAgICAgInN5c3RlbSI6ICJodHRwOi8vdW5pdHNvZm1lYXN1cmUub3JnIiwgICAgICAgICAgImNvZGUiOiAibWcvZEwiICAgICAgICB9LCAgICAgICAgImhpZ2giOiB7ICAgICAgICAgICJ2YWx1ZSI6IDExMCwgICAgICAgICAgInVuaXQiOiAibWcvZEwiLCAgICAgICAgICAic3lzdGVtIjogImh0dHA6Ly91bml0c29mbWVhc3VyZS5vcmciLCAgICAgICAgICAiY29kZSI6ICJtZy9kTCIgICAgICAgIH0gICAgICB9IF0gICAgfSAgfSwgeyAgICAiZnVsbFVybCI6ICJ1cm46dXVpZDphZGFiYjkwNy04ODU2LTUyMjUtYTY5ZS00Mjk1OGZjYTVlOGIiLCAgICAicmVzb3VyY2UiOiB7ICAgICAgInJlc291cmNlVHlwZSI6ICJTcGVjaW1lbiIsICAgICAgImlkIjogIjYzMDAwNDQ3MDMwMSIsICAgICAgIm1ldGEiOiB7ICAgICAgICAicHJvZmlsZSI6IFsgImh0dHBzOi8vd3d3LmVoZWFsdGguZmdvdi5iZS9zdGFuZGFyZHMvZmhpci9sYWIvU3RydWN0dXJlRGVmaW5pdGlvbi9iZS1zcGVjaW1lbi1sYWJvcmF0b3J5IiBdICAgICAgfSwgICAgICAidGV4dCI6IHsgICAgICAgICJzdGF0dXMiOiAiZW1wdHkiLCAgICAgICAgImRpdiI6ICI8ZGl2IHhtbG5zPVwiaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbFwiPmVtcHR5PC9kaXY+IiAgICAgIH0sICAgICAgImlkZW50aWZpZXIiOiBbIHsgICAgICAgICJzeXN0ZW0iOiAiaHR0cHM6Ly93d3cuaGlzLWl6ei5iZSIsICAgICAgICAidmFsdWUiOiAiNjMwMDA0NDcwMzAxIiAgICAgIH0gXSwgICAgICAic3RhdHVzIjogImF2YWlsYWJsZSIsICAgICAgInR5cGUiOiB7ICAgICAgICAiY29kaW5nIjogWyB7ICAgICAgICAgICJzeXN0ZW0iOiAiaHR0cDovL3Nub21lZC5pbmZvL3NjdCIsICAgICAgICAgICJjb2RlIjogIjExOTM2NDAwMyIgICAgICAgIH0gXSwgICAgICAgICJ0ZXh0IjogIlNlcnVtIiAgICAgIH0sICAgICAgInN1YmplY3QiOiB7ICAgICAgICAicmVmZXJlbmNlIjogInVybjp1dWlkOjg0MjBlMmExLWYyNDEtNTNjYy1hOGNiLTc5MTNlMjkzMTM3MCIgICAgICB9LCAgICAgICJyZWNlaXZlZFRpbWUiOiAiMjAyNC0xMC0yMlQxMzowNzoxNiswMjowMCIsICAgICAgInJlcXVlc3QiOiBbIHsgICAgICAgICJyZWZlcmVuY2UiOiAidXJuOnV1aWQ6ZTI5ODU2OTktNzRiNi01N2NlLTk3NzUtOTU5N2I3YWM4MmE2IiAgICAgIH0gXSwgICAgICAiY29sbGVjdGlvbiI6IHsgICAgICAgICJjb2xsZWN0ZWREYXRlVGltZSI6ICIyMDI0LTEwLTIyVDEzOjA2OjAwKzAyOjAwIiAgICAgIH0gICAgfSAgfSBdfQ=="
        )

        runBlocking {
            NarrativeBuilder.makeNarrative(fhirData, false)
            fhirValidatorAsync().await().validate(fhirData)
        }
    }

    @PostMapping("html", consumes = ["application/json", "application/xml"])
    @Operation(summary = "Convert FHIR file to html")
    override fun html(@RequestBody fhirFile: ByteArray, response: ServerHttpResponse): Mono<Void> =
            ResponseBuilder.makeResponse(fhirFile, response, true)

    @PostMapping("html/validate", consumes = ["application/json", "application/xml"])
    @Operation(summary = "Validate and convert FHIR file to object including validation information and html representation")
    override fun htmlAndValidate(@RequestBody fhirFile: ByteArray) = mono {

        fhirValidatorAsync().await().validate(fhirFile).let { (errors, validationReport) ->
            HtmlWithValidation(
                    html = NarrativeBuilder.makeNarrative(fhirFile, true).toString(Charsets.UTF_8),
                    errors = errors,
                    validation = validationReport
            )
        }

    }

    @PostMapping("validate", consumes = ["application/json", "application/xml"])
    @Operation(summary = "Validate Lab report")
    override fun validate(@RequestBody fhirFile: ByteArray) = mono {

        fhirValidatorAsync().await().validate(fhirFile).let { (errors) ->
            Validation(
                    errors = errors
            )
        }
    }
}
